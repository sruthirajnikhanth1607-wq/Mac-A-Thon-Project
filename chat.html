// CitySense AI Safety Assistant
const API_URL = '/api/chat';

// DOM Elements
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');

// Initial welcome message
window.onload = function() {
    addMessage("Hello! I'm CitySense, your AI safety assistant. How can I help you stay safe today?", 'bot');
    addQuickReplies();
};

// Add message to chat
function addMessage(text, sender = 'user') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const timestamp = new Date().toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    // Format message with emojis and line breaks
    const formattedText = text
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    messageDiv.innerHTML = `
        <div class="message-content">
            <div class="message-sender">${sender === 'user' ? 'You' : 'CitySense'}</div>
            <div class="message-text">${formattedText}</div>
            <div class="message-time">${timestamp}</div>
        </div>
    `;
    
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Add quick reply buttons
function addQuickReplies() {
    const quickReplies = [
        { text: "Walking alone at night", msg: "Is it safe to walk downtown alone at night?" },
        { text: "Feeling followed", msg: "I think someone is following me. What should I do?" },
        { text: "Public transit safety", msg: "How do I stay safe on public transportation?" },
        { text: "Emergency steps", msg: "What should I do in an emergency situation?" }
    ];
    
    const quickReplyDiv = document.createElement('div');
    quickReplyDiv.className = 'quick-replies';
    
    quickReplies.forEach(reply => {
        const button = document.createElement('button');
        button.className = 'quick-reply-btn';
        button.textContent = reply.text;
        button.onclick = () => {
            userInput.value = reply.msg;
            sendMessage();
        };
        quickReplyDiv.appendChild(button);
    });
    
    chatBox.appendChild(quickReplyDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Send message to AI
async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    userInput.value = '';
    
    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'message bot-message typing';
    typingIndicator.innerHTML = `
        <div class="message-content">
            <div class="message-sender">CitySense</div>
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    chatBox.appendChild(typingIndicator);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    try {
        // Send to backend API
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                sessionId: 'citysense_user'
            })
        });
        
        const data = await response.json();
        
        // Remove typing indicator
        typingIndicator.remove();
        
        if (data.success) {
            // Check if emergency response
            if (data.isEmergency) {
                addMessage(data.message, 'bot');
                // Add emergency notice
                const emergencyNotice = document.createElement('div');
                emergencyNotice.className = 'emergency-notice';
                emergencyNotice.innerHTML = `
                    ‚ö†Ô∏è <strong>Emergency Alert:</strong> If you're in immediate danger, call 911 or local authorities now!
                `;
                chatBox.appendChild(emergencyNotice);
            } else {
                addMessage(data.message, 'bot');
            }
        } else {
            addMessage("Sorry, I'm having trouble connecting. Please try again.", 'bot');
        }
        
    } catch (error) {
        typingIndicator.remove();
        addMessage("Network error. Please check your connection and try again.", 'bot');
        console.error('Error:', error);
    }
    
    // Remove old quick replies and add new ones
    document.querySelectorAll('.quick-replies').forEach(el => el.remove());
    addQuickReplies();
}

// Get user location
function getLocation() {
    if (!navigator.geolocation) {
        addMessage("Location services are not supported by your browser.", 'bot');
        return;
    }
    
    addMessage("Getting your location for personalized safety advice...", 'bot');
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Update message with location
            addMessage(`üìç Location enabled! I can now provide location-specific safety advice for your area.`, 'bot');
            
            // You can store the location for future API calls
            window.userLocation = { lat, lng };
            
            // Add location-specific advice
            setTimeout(() => {
                addMessage("Based on your location, I recommend staying in well-lit areas, avoiding shortcuts through alleys, and keeping your phone charged when walking at night.", 'bot');
            }, 1000);
        },
        (error) => {
            addMessage("Couldn't get your location. Please enable location permissions in your browser settings.", 'bot');
        }
    );
}

// Make sendMessage available globally
window.sendMessage = sendMessage;
window.getLocation = getLocation;