<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SafeSense ‚Äì Trip Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f8; overflow: hidden; }
    
    /* --- 1. Top Search Bar --- */
    #search-controls {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px; z-index: 1000;
      display: flex; gap: 8px;
    }

    .search-wrapper {
      flex: 1; position: relative; display: flex;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 50px; background: white;
    }
    
    #destination {
      flex: 1; padding: 12px 20px; font-size: 1rem; border: none; outline: none; background: transparent; border-radius: 50px;
    }

    #search-btn {
      padding: 12px 20px; border: none; background: #b91c1c; color: white;
      font-weight: bold; cursor: pointer; border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    #search-btn:hover { background: #991b1b; }

    /* --- 2. Trip Info Card (The "Previous Option" Restored & Upgraded) --- */
    #trip-card {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px;
      background: white; padding: 20px; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1000; display: none; /* Hidden until search */
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translate(-50%, 100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    .trip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .trip-title { font-weight: bold; font-size: 1.1rem; color: #1f2933; }
    .close-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #666; }

    .trip-stats { display: flex; gap: 15px; margin-bottom: 15px; }
    .stat-box { flex: 1; background: #f3f4f6; padding: 10px; border-radius: 10px; text-align: center; }
    .stat-val { font-weight: bold; font-size: 1.1rem; display: block; color: #2563eb; }
    .stat-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }

    .mode-selector { display: flex; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 15px; }
    .mode-btn { 
      flex: 1; border: none; background: transparent; padding: 8px; border-radius: 8px; 
      cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background 0.2s;
    }
    .mode-btn.active { background: white; color: #1f2933; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .start-btn {
      width: 100%; padding: 12px; background: #1f2933; color: white; border: none; 
      border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer;
    }
    .start-btn:hover { background: #374151; }

    /* --- 3. Map & Legend --- */
    #map { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
    
    .back-btn {
      position: absolute; top: 20px; left: 20px; z-index: 1000;
      background: white; border: none; padding: 10px 15px; border-radius: 50px;
      cursor: pointer; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      text-decoration: none; color: #374151; font-size: 0.9rem;
    }

    .legend {
      background: white; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 0.8rem;
    }
  </style>
</head>

<body>

<a href="index.html" class="back-btn">‚Üê Home</a>

<div id="search-controls">
  <div class="search-wrapper">
    <input id="destination" type="text" placeholder="Where do you want to go?" onkeypress="if(event.key==='Enter') triggerSearch()">
  </div>
  <button id="search-btn" onclick="triggerSearch()">Go</button>
</div>

<div id="trip-card">
  <div class="trip-header">
    <span class="trip-title">Trip Planner</span>
    <button class="close-btn" onclick="closeTripCard()">√ó</button>
  </div>

  <div class="mode-selector">
    <button class="mode-btn active" id="btn-drive" onclick="setMode('driving')">üöó Drive</button>
    <button class="mode-btn" id="btn-walk" onclick="setMode('walking')">üö∂ Walk</button>
  </div>

  <div class="trip-stats">
    <div class="stat-box">
      <span class="stat-val" id="trip-time">-- min</span>
      <span class="stat-label">Est. Time</span>
    </div>
    <div class="stat-box">
      <span class="stat-val" id="trip-dist">-- km</span>
      <span class="stat-label">Distance</span>
    </div>
  </div>

  <button class="start-btn" onclick="startNavigation()">Start Safe Route</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --- 1. Map Initialization ---
// Default: Toronto (fallback if geolocation fails)
let map = L.map("map").setView([43.6532, -79.3832], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap contributors"
}).addTo(map);

let userMarker, destMarker, routeLine, geojsonLayer;
let currentMode = 'driving'; // 'driving' or 'walking'
let userPos = null;          // Store lat/lng object
let destPos = null;          // Store lat/lng object

// --- 2. Get User Location ---
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    
    // User Marker (Blue Dot)
    userMarker = L.marker([userPos.lat, userPos.lng]).addTo(map)
      .bindPopup("You are here").openPopup();
    
    map.setView([userPos.lat, userPos.lng], 14);
    loadRiskData(); // Load colored overlays
  }, () => {
    alert("Location access denied. Please search manually.");
    loadRiskData();
  });
} else {
  loadRiskData();
}

// --- 3. Search & Route Logic ---
async function triggerSearch() {
  const query = document.getElementById("destination").value;
  if (!query) return;

  // 3a. Find Coordinates (Nominatim API)
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.length) { alert("Location not found."); return; }

    const place = data[0];
    destPos = { lat: parseFloat(place.lat), lng: parseFloat(place.lon) };

    // 3b. Update Map
    if (destMarker) map.removeLayer(destMarker);
    destMarker = L.marker([destPos.lat, destPos.lng]).addTo(map)
      .bindPopup(`<strong>${place.display_name.split(',')[0]}</strong>`).openPopup();

    // 3c. Calculate Route & Stats
    calculateTrip();

  } catch (err) {
    console.error(err);
    alert("Search failed. Check connection.");
  }
}

async function calculateTrip() {
  if (!userPos || !destPos) return;

  // Show the Trip Card
  document.getElementById("trip-card").style.display = "block";

  // 1. Draw Line (Visual only for now)
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline([
    [userPos.lat, userPos.lng],
    [destPos.lat, destPos.lng]
  ], { color: '#2563eb', dashArray: '10, 10', weight: 4 }).addTo(map);

  map.fitBounds(routeLine.getBounds(), { padding: [50, 150] }); // Leave room for card

  // 2. Calculate Distance (Haversine Formula)
  const distKm = getDistance(userPos.lat, userPos.lng, destPos.lat, destPos.lng);
  document.getElementById("trip-dist").innerText = distKm.toFixed(1) + " km";

  // 3. Estimate Time based on Mode
  // Speed assumptions: Walking = 5 km/h, Driving = 40 km/h (City avg)
  let speed = (currentMode === 'walking') ? 5 : 40;
  let timeMin = Math.round((distKm / speed) * 60);
  
  // Format nice time string
  let timeStr = timeMin + " min";
  if (timeMin > 60) {
    const hrs = Math.floor(timeMin / 60);
    const mins = timeMin % 60;
    timeStr = `${hrs} hr ${mins} min`;
  }

  document.getElementById("trip-time").innerText = timeStr;
}

// --- 4. Utilities ---
function setMode(mode) {
  currentMode = mode;
  // Update buttons
  document.getElementById("btn-drive").className = mode === 'driving' ? 'mode-btn active' : 'mode-btn';
  document.getElementById("btn-walk").className = mode === 'walking' ? 'mode-btn active' : 'mode-btn';
  
  // Recalculate if trip is active
  if (destPos) calculateTrip();
}

function startNavigation() {
  alert("Safe Route started! Monitoring risk levels along your path...");
  // In a real app, this would start turn-by-turn navigation
}

function closeTripCard() {
  document.getElementById("trip-card").style.display = "none";
  if (routeLine) map.removeLayer(routeLine);
  if (destMarker) map.removeLayer(destMarker);
  document.getElementById("destination").value = "";
}

// Simple distance calc (Haversine)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth radius km
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  return R * c;
}

function deg2rad(deg) { return deg * (Math.PI/180); }

// --- 5. Risk Heatmap Logic (Existing) ---
const DANGER_COLORS = { low: "#22c55e", elevated: "#eab308", high: "#f97316", veryHigh: "#dc2626" };
let maxRisk = 0;

async function loadRiskData() {
  try {
    const response = await fetch('data/neighbourhood-crime-rates.geojson');
    if (!response.ok) return; // Silent fail if no data
    const geojson = await response.json();

    maxRisk = Math.max(...geojson.features.map(f => 
      (f.properties.ASSAULT_RATE_2025 || 0) + (f.properties.AUTOTHEFT_RATE_2025 || 0)
    ), 1);

    if (geojsonLayer) map.removeLayer(geojsonLayer);
    geojsonLayer = L.geoJSON(geojson, {
      style: (feature) => {
        const risk = (feature.properties.ASSAULT_RATE_2025 || 0) + (feature.properties.AUTOTHEFT_RATE_2025 || 0);
        return { fillColor: getColor(risk), fillOpacity: 0.5, color: "#555", weight: 1 };
      },
      onEachFeature: (feature, layer) => {
         layer.bindPopup(`<strong>${feature.properties.AREA_NAME}</strong><br>Risk Score: ${Math.round(risk)}`);
      }
    }).addTo(map);
  } catch (err) {}
}

function getColor(score) {
  const pct = score / maxRisk;
  if (pct >= 0.75) return DANGER_COLORS.veryHigh;
  if (pct >= 0.5) return DANGER_COLORS.high;
  if (pct >= 0.25) return DANGER_COLORS.elevated;
  return DANGER_COLORS.low;
}

// Legend
const legend = L.control({ position: "bottomright" });
legend.onAdd = () => {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `<strong>Danger Level</strong><br>
    <span style="color:${DANGER_COLORS.low}">‚óè</span> Low<br>
    <span style="color:${DANGER_COLORS.elevated}">‚óè</span> Elevated<br>
    <span style="color:${DANGER_COLORS.high}">‚óè</span> High<br>
    <span style="color:${DANGER_COLORS.veryHigh}">‚óè</span> Very High`;
  return div;
};
legend.addTo(map);

</script>
</body>
</html>