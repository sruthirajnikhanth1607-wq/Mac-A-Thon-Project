<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>SafeSense – Risk Highlight Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- Reset / Base --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            background-color: #f4f6f8;
            color: #1f2933;
        }

        /* --- Container --- */
        #container {
            max-width: 1100px;
            margin: auto;
            padding: 1rem;
        }

        /* --- Header --- */
        #header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        #header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        #header p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* --- Controls --- */
        #controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        #controls input,
        #controls button {
            padding: 0.7rem 1rem;
            font-size: 1rem;
            border-radius: 10px;
            border: 1px solid #d1d5db;
        }

        #controls button {
            background-color: #b91c1c;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        #controls button:hover {
            background-color: #991b1b;
        }

        input:focus {
            outline: none;
            border-color: #b91c1c;
            box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.2);
        }

        /* --- Map Card --- */
        #map {
            height: 300px;
            width: 100%;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            margin-bottom: 2rem;
        }

        /* --- Legend --- */
        .legend {
            background: white;
            padding: 12px;
            line-height: 1.5;
            font-size: 0.9rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* --- Responsive adjustments --- */
        @media (min-width: 640px) {
            #controls {
                flex-direction: row;
                justify-content: center;
            }

            #controls input {
                flex: 1 1 300px;
            }

            #map {
                height: 400px;
            }
        }

        @media (min-width: 1024px) {
            #map {
                height: 450px;
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="header">
            <h1>SafeSense</h1>
            <p>Highlighting higher-risk areas only</p>
        </div>

        <div id="controls">
            <input id="destination" type="text" placeholder="Enter destination (e.g. McMaster University)">
            <button onclick="setDestination()">Set Destination</button>
        </div>

        <div id="map"></div>
    </div>

    <!-- Leaflet JS + Heatmap plugin -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
        let map = L.map("map").setView([0, 0], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap contributors"
        }).addTo(map);

        let userMarker;
        let destinationMarker;
        let routeLine;
        let heatLayer;

        /* Risk points */
        function generateRiskPoints(center) {
            const points = [];
            for (let i = 0; i < 80; i++) {
                const latOffset = (Math.random() - 0.5) * 0.025;
                const lngOffset = (Math.random() - 0.5) * 0.025;

                const r = Math.random();
                let risk;

                if (r < 0.55) continue;
                else if (r < 0.75) risk = 0.45 + Math.random() * 0.15;
                else if (r < 0.9) risk = 0.65 + Math.random() * 0.15;
                else risk = 0.85 + Math.random() * 0.15;

                points.push([center.lat + latOffset, center.lng + lngOffset, risk]);
            }
            return points;
        }

        function drawRiskHeatmap(center) {
            if (heatLayer) map.removeLayer(heatLayer);

            heatLayer = L.heatLayer(generateRiskPoints(center), {
                radius: 45,
                blur: 18,
                maxZoom: 17,
                minOpacity: 0.6,
                gradient: {
                    0.4: "#f1c40f",
                    0.6: "#f39c12",
                    0.8: "#e67e22",
                    1.0: "#e74c3c"
                }
            }).addTo(map);
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    userMarker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup("You are here")
                        .openPopup();

                    map.setView([lat, lng], 15);
                    drawRiskHeatmap({ lat, lng });
                },
                () => alert("Location access denied.")
            );
        }

        async function setDestination() {
            const place = document.getElementById("destination").value;
            if (!place || !userMarker) return;

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(place)}`
                );

                if (!response.ok) throw new Error("Fetch failed");

                const data = await response.json();
                if (!data.length) throw new Error("Not found");

                const lat = data[0].lat;
                const lng = data[0].lon;

                if (destinationMarker) map.removeLayer(destinationMarker);
                destinationMarker = L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup("Destination")
                    .openPopup();

                if (routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline([userMarker.getLatLng(), [lat, lng]], { dashArray: "5,5" })
                    .addTo(map);

                map.fitBounds(routeLine.getBounds());
            } catch (err) {
                alert("Destination lookup failed. Run via localhost.");
                console.error(err);
            }
        }

        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = `
                <strong>Risk Level</strong><br>
                <span style="color:#f1c40f">●</span> Elevated risk<br>
                <span style="color:#f39c12">●</span> High risk<br>
                <span style="color:#e74c3c">●</span> Very high risk
            `;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
