<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SafeSense – High-Risk Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #header {
      background: #1f2933;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    #controls {
      padding: 0.75rem 1rem;
      background: #f4f6f8;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    #controls input {
      flex: 1 1 200px;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    #controls button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      background: #b91c1c;
      color: white;
      cursor: pointer;
    }

    #map {
      width: 100%;
      height: 80vh;
    }

    .legend {
      background: white;
      padding: 8px 12px;
      font-size: 0.85rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

  <div id="header">
    <h1>SafeSense</h1>
    <p>Only showing high-risk areas</p>
  </div>

  <div id="controls">
    <input id="destination" placeholder="Enter destination (e.g. McMaster University)">
    <button onclick="setDestination()">Set Destination</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map
    let map = L.map("map").setView([43.6532, -79.3832], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // ----------------------
    // Made-up high-risk areas only
    // ----------------------
    const areas = [
      { name: "Downtown Toronto", riskIndex: 0.9, polygon: [[43.64,-79.40],[43.64,-79.37],[43.67,-79.37],[43.67,-79.40]] },
      { name: "Scarborough", riskIndex: 0.7, polygon: [[43.76,-79.30],[43.76,-79.18],[43.79,-79.18],[43.79,-79.30]] },
      { name: "Mississauga", riskIndex: 0.6, polygon: [[43.58,-79.68],[43.58,-79.60],[43.61,-79.60],[43.61,-79.68]] },
      { name: "Brampton", riskIndex: 0.7, polygon: [[43.67,-79.78],[43.67,-79.74],[43.70,-79.74],[43.70,-79.78]] },
      { name: "Hamilton", riskIndex: 0.8, polygon: [[43.25,-79.90],[43.25,-79.84],[43.30,-79.84],[43.30,-79.90]] }
    ];

    // ----------------------
    // Gradient dark red based on risk
    // ----------------------
    function getDarkRedGradient(norm) {
      // norm is 0.5 to 1.0 for high-risk only
      return norm > 0.85 ? "#7f0000" :   // extreme
             norm > 0.7  ? "#b91c1c" :   // very high
             norm > 0.55 ? "#f97316" :   // high
                           "#fca5a5";   // moderate-high
    }

    // ----------------------
    // Draw high-risk polygons
    // ----------------------
    areas.forEach(area => {
      const color = getDarkRedGradient(area.riskIndex);
      L.polygon(area.polygon, {
        color: "#374151",
        fillColor: color,
        fillOpacity: 0.7,
        weight: 1
      }).addTo(map)
        .bindPopup(`<strong>${area.name}</strong><br>Risk Index: ${(area.riskIndex*100).toFixed(0)}%`);
    });

    // ----------------------
    // Legend
    // ----------------------
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = () => {
      const div = L.DomUtil.create("div","legend");
      div.innerHTML = `
        <strong>High-Risk Areas</strong><br>
        <i style="background:#fca5a5;width:18px;display:inline-block"></i> Moderate-High<br>
        <i style="background:#f97316;width:18px;display:inline-block"></i> High<br>
        <i style="background:#b91c1c;width:18px;display:inline-block"></i> Very High<br>
        <i style="background:#7f0000;width:18px;display:inline-block"></i> Extreme
      `;
      return div;
    };
    legend.addTo(map);

    // ----------------------
    // User & destination
    // ----------------------
    let userMarker, destinationMarker, routeLine;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(p => {
        const lat = p.coords.latitude;
        const lon = p.coords.longitude;
        userMarker = L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
        map.setView([lat, lon], 12);
      });
    }

    async function setDestination() {
      const query = document.getElementById("destination").value;
      if (!query || !userMarker) return;

      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`);
      const loc = await res.json();
      if (!loc.length) return alert("Not found");

      const [lat, lon] = [loc[0].lat, loc[0].lon];

      if (destinationMarker) map.removeLayer(destinationMarker);
      destinationMarker = L.marker([lat, lon]).addTo(map).bindPopup("Destination").openPopup();

      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline([userMarker.getLatLng(), [lat, lon]], { dashArray: "5,5" }).addTo(map);

      map.fitBounds(routeLine.getBounds());
    }
  </script>

</body>
</html>
