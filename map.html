<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SafeSense – Global Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f6f8; }
    
    /* Floating Search Bar */
    #controls {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 450px; z-index: 1000;
      display: flex; flex-direction: column;
    }

    .search-container { 
      display: flex; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
      border-radius: 50px; 
      background: white; 
      overflow: hidden;
    }
    
    #destination {
      flex: 1; padding: 14px 20px; font-size: 1rem; border: none; outline: none;
    }

    #search-btn {
      padding: 14px 24px; border: none; background: #2563eb; color: white;
      font-weight: bold; cursor: pointer; font-size: 1rem;
    }
    #search-btn:hover { background: #1d4ed8; }

    /* Dropdown results */
    #results-list {
      background: white; margin-top: 8px; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      list-style: none; padding: 0; max-height: 250px; overflow-y: auto; 
      display: none;
    }

    #results-list li {
      padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 0.95rem;
    }
    #results-list li:hover { background-color: #f8fafc; color: #2563eb; }

    #map { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }

    /* Home Button */
    .back-btn {
      position: absolute; top: 20px; left: 20px; z-index: 1000;
      background: white; border: none; padding: 10px 15px; border-radius: 50px;
      cursor: pointer; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      display: flex; align-items: center; gap: 5px; color: #374151; text-decoration: none;
    }
    .back-btn:hover { background: #f3f4f6; }

    /* Legend */
    .legend {
      background: white; padding: 12px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 0.85rem; line-height: 1.5;
    }
  </style>
</head>

<body>

<a href="index.html" class="back-btn">← Home</a>

<div id="controls">
  <div class="search-container">
    <input id="destination" type="text" placeholder="Search any city or place..." autocomplete="off">
    <button id="search-btn" onclick="triggerSearch()">Search</button>
  </div>
  <ul id="results-list"></ul>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// 1. Initialize Map (Default view: World)
let map = L.map("map").setView([20, 0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

let userMarker, destinationMarker, routeLine, geojsonLayer;
let searchTimeout;

// 2. Track User Location (if allowed)
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    userMarker = L.marker([lat, lng]).addTo(map).bindPopup("Your Location").openPopup();
    map.setView([lat, lng], 13);
    loadLocalData(); // Try to load heatmap if in coverage area
  }, () => {
    console.log("Location denied. Defaulting to world view.");
    loadLocalData();
  });
} else {
  loadLocalData();
}

// 3. GLOBAL Search Logic (Autocomplete)
const input = document.getElementById("destination");
const resultsList = document.getElementById("results-list");

input.addEventListener("input", function() {
  clearTimeout(searchTimeout);
  const query = this.value;
  
  if (query.length < 3) {
    resultsList.style.display = "none";
    return;
  }

  // Delay search by 300ms to avoid spamming the API
  searchTimeout = setTimeout(() => searchGlobal(query), 300);
});

async function searchGlobal(query) {
  // REMOVED 'viewbox' and 'bounded' parameters to enable GLOBAL search
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    resultsList.innerHTML = "";
    if (data.length === 0) {
      resultsList.style.display = "none";
      return;
    }

    data.forEach(place => {
      const li = document.createElement("li");
      // Show City, State, Country clearly
      const displayName = place.display_name;
      li.textContent = displayName;
      li.onclick = () => selectDestination(place.lat, place.lon, displayName);
      resultsList.appendChild(li);
    });
    resultsList.style.display = "block";
  } catch (err) {
    console.error("Search error:", err);
  }
}

function selectDestination(lat, lon, name) {
  resultsList.style.display = "none";
  input.value = name;

  // 1. Move map
  map.setView([lat, lon], 14);

  // 2. Add marker
  if (destinationMarker) map.removeLayer(destinationMarker);
  destinationMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup(`<strong>${name}</strong><br><button onclick="askChatbot('${name}')" style="margin-top:5px;cursor:pointer;">Ask Chatbot about this</button>`)
    .openPopup();

  // 3. Draw line if user location is known
  if (userMarker) {
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([userMarker.getLatLng(), [lat, lon]], { color: '#2563eb', dashArray: '5, 10', weight: 4 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
  }
}

function triggerSearch() {
  if(input.value) searchGlobal(input.value);
}

// Helper to send location to Chatbot (Optional feature)
function askChatbot(locationName) {
    alert(`Tip: Go to the Chatbot page and ask: "Is ${locationName} safe?"`);
    // Advanced: You could save this to localStorage to auto-fill the chat
}

// 4. Load Heatmap Data (Note: This is static data, likely just for Toronto)
const DANGER_COLORS = { low: "#22c55e", elevated: "#eab308", high: "#f97316", veryHigh: "#dc2626" };
let maxRisk = 0;

async function loadLocalData() {
  try {
    const response = await fetch('data/neighbourhood-crime-rates.geojson');
    if (!response.ok) throw new Error("No data file");
    const geojson = await response.json();

    maxRisk = Math.max(...geojson.features.map(f => 
      (f.properties.ASSAULT_RATE_2025 || 0) + (f.properties.AUTOTHEFT_RATE_2025 || 0)
    ), 1);

    if (geojsonLayer) map.removeLayer(geojsonLayer);
    geojsonLayer = L.geoJSON(geojson, {
      style: (feature) => {
        const risk = (feature.properties.ASSAULT_RATE_2025 || 0) + (feature.properties.AUTOTHEFT_RATE_2025 || 0);
        return { fillColor: getColor(risk), fillOpacity: 0.5, color: "#374151", weight: 1 };
      },
      onEachFeature: (feature, layer) => {
         layer.bindPopup(`<strong>${feature.properties.AREA_NAME}</strong><br>Risk Score: ${Math.round((feature.properties.ASSAULT_RATE_2025||0) + (feature.properties.AUTOTHEFT_RATE_2025||0))}`);
      }
    }).addTo(map);
  } catch (err) { 
      // Do nothing silently if data isn't found (common for global maps)
  }
}

function getColor(score) {
  const pct = score / maxRisk;
  if (pct >= 0.75) return DANGER_COLORS.veryHigh;
  if (pct >= 0.5) return DANGER_COLORS.high;
  if (pct >= 0.25) return DANGER_COLORS.elevated;
  return DANGER_COLORS.low;
}

// Legend
const legend = L.control({ position: "bottomright" });
legend.onAdd = () => {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `<strong>Danger Level</strong><br>
    <span style="color:${DANGER_COLORS.low}">●</span> Low<br>
    <span style="color:${DANGER_COLORS.elevated}">●</span> Elevated<br>
    <span style="color:${DANGER_COLORS.high}">●</span> High<br>
    <span style="color:${DANGER_COLORS.veryHigh}">●</span> Very High<br>
    <small style="color:#666; margin-top:5px; display:block;">(Data available for specific regions only)</small>`;
  return div;
};
legend.addTo(map);

</script>
</body>

</html>