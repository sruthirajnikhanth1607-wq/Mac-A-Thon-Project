<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SafeSense – Risk Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f4f6f8;
    }

    #header {
      background: #1f2933;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    #controls {
      padding: 0.75rem 1rem;
      background: #f4f6f8;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    #controls input {
      flex: 1 1 200px;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    #controls button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      background-color: #b91c1c;
      color: white;
      cursor: pointer;
    }

    #map {
      width: 100%;
      height: 80vh;
    }

    .legend {
      background: white;
      padding: 8px 12px;
      font-size: 0.85rem;
      line-height: 1.4;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    @media (min-width: 768px) {
      #map { height: 70vh; }
      #controls { justify-content: flex-start; }
    }
  </style>
</head>

<body>

<div id="header">
  <h1>SafeSense</h1>
  <p>Highlighting higher-risk areas only</p>
</div>

<div id="controls">
  <input id="destination" type="text" placeholder="Enter destination (e.g. McMaster University)">
  <button onclick="setDestination()">Set Destination</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map("map").setView([43.6532, -79.3832], 13); // Default Toronto
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

let userMarker, destinationMarker, routeLine, geojsonLayer;

// --- Get user location ---
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    userMarker = L.marker([lat, lng]).addTo(map)
      .bindPopup("You are here").openPopup();

    map.setView([lat, lng], 14);

    loadData(); // load heatmap once location is known
  }, () => {
    alert("Location access denied.");
    loadData(); // still load heatmap without user location
  });
} else {
  loadData(); // no geolocation available
}

// --- Compute centroid of polygons ---
function getCentroid(feature) {
  const geom = feature.geometry;
  let coords = [];

  if (geom.type === "Polygon") coords = geom.coordinates[0];
  else if (geom.type === "MultiPolygon") coords = geom.coordinates[0][0];
  else return null;

  let sumLat = 0, sumLng = 0;
  coords.forEach(c => { sumLng += c[0]; sumLat += c[1]; });
  return [sumLat / coords.length, sumLng / coords.length]; // [lat,lng]
}

// --- Danger level colors (from data: assault + auto-theft rate 2025) ---
const DANGER_COLORS = {
  low:      "#22c55e",  // green
  elevated: "#eab308",  // yellow/amber
  high:     "#f97316",  // orange
  veryHigh: "#dc2626"   // red
};

function getDangerLevel(combinedRate, maxRisk) {
  if (maxRisk <= 0) return "low";
  const pct = combinedRate / maxRisk;
  if (pct >= 0.75) return "veryHigh";
  if (pct >= 0.5)  return "high";
  if (pct >= 0.25) return "elevated";
  return "low";
}

let maxRisk = 0;

async function loadData() {
  try {
    const response = await fetch('data/neighbourhood-crime-rates.geojson');
    const geojson = await response.json();

    maxRisk = Math.max(...geojson.features.map(f =>
      (f.properties.ASSAULT_RATE_2025 || 0) + (f.properties.AUTOTHEFT_RATE_2025 || 0)
    ), 1);

    drawChoropleth(geojson);
  } catch (err) {
    console.error("Failed to load GeoJSON:", err);
  }
}

// --- Draw color-coded neighbourhoods by danger level ---
function drawChoropleth(geojson) {
  if (geojsonLayer) map.removeLayer(geojsonLayer);

  geojsonLayer = L.geoJSON(geojson, {
    style: (feature) => {
      const assault = feature.properties.ASSAULT_RATE_2025 || 0;
      const theft = feature.properties.AUTOTHEFT_RATE_2025 || 0;
      const combined = assault + theft;
      const level = getDangerLevel(combined, maxRisk);
      const fillColor = DANGER_COLORS[level];
      return {
        fillColor,
        fillOpacity: 0.65,
        color: "#374151",
        weight: 1
      };
    },
    onEachFeature: (feature, layer) => {
      const assault = feature.properties.ASSAULT_RATE_2025 || 0;
      const theft = feature.properties.AUTOTHEFT_RATE_2025 || 0;
      const combined = assault + theft;
      const level = getDangerLevel(combined, maxRisk);
      const levelLabel = { low: "Low", elevated: "Elevated", high: "High", veryHigh: "Very High" }[level];
      layer.bindPopup(`
        <strong>${feature.properties.AREA_NAME}</strong><br>
        <span style="color:${DANGER_COLORS[level]}">● ${levelLabel} danger</span><br>
        Assault Rate (2025): ${Math.round(assault)}<br>
        Auto Theft Rate (2025): ${Math.round(theft)}<br>
        Combined Risk: ${Math.round(combined)}
      `);
    }
  }).addTo(map);
}

// --- Destination lookup ---
async function setDestination() {
  const place = document.getElementById("destination").value;
  if (!place || !userMarker) return;

  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(place)}`);
    const data = await res.json();
    if (!data.length) throw new Error("Not found");

    const lat = data[0].lat;
    const lng = data[0].lon;

    if (destinationMarker) map.removeLayer(destinationMarker);
    destinationMarker = L.marker([lat, lng]).addTo(map)
      .bindPopup("Destination").openPopup();

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([userMarker.getLatLng(), [lat, lng]], { dashArray: "5,5" }).addTo(map);

    map.fitBounds(routeLine.getBounds());
  } catch (err) {
    alert("Destination lookup failed. Run via localhost.");
    console.error(err);
  }
}

// --- Legend (danger level from neighbourhood-crime-rates data) ---
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <strong>Danger Level</strong><br>
    <span style="color:${DANGER_COLORS.low}">●</span> Low<br>
    <span style="color:${DANGER_COLORS.elevated}">●</span> Elevated<br>
    <span style="color:${DANGER_COLORS.high}">●</span> High<br>
    <span style="color:${DANGER_COLORS.veryHigh}">●</span> Very High
  `;
  return div;
};
legend.addTo(map);
</script>

</body>
</html>
