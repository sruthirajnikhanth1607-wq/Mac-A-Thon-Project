<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SafeSense – Risk Highlight Map</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #header {
            background: #1f2933;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        #controls {
            padding: 1rem;
            background: #f5f5f5;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        #map {
            height: 80vh;
            width: 100%;
        }

        input, button {
            padding: 0.5rem;
            font-size: 1rem;
        }

        button {
            cursor: pointer;
        }

        .legend {
            background: white;
            padding: 10px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

<div id="header">
    <h1>SafeSense</h1>
    <p>Highlighting higher-risk areas only</p>
</div>

<div id="controls">
    <input
        id="destination"
        type="text"
        placeholder="Enter destination (e.g. McMaster University)"
    >
    <button onclick="setDestination()">Set Destination</button>
</div>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Heatmap plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
let map = L.map("map").setView([0, 0], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors"
}).addTo(map);

let userMarker;
let destinationMarker;
let routeLine;
let heatLayer;

/*
  Risk values:
  < 0.4  → ignored (safe area, no color)
  0.4–1  → shown (yellow → red)
*/
function generateRiskPoints(center) {
    const points = [];

    for (let i = 0; i < 80; i++) {
        const latOffset = (Math.random() - 0.5) * 0.025;
        const lngOffset = (Math.random() - 0.5) * 0.025;

        const r = Math.random();
        let risk;

        if (r < 0.55) {
            continue; // safe → do not display
        } else if (r < 0.75) {
            risk = 0.45 + Math.random() * 0.15; // yellow
        } else if (r < 0.9) {
            risk = 0.65 + Math.random() * 0.15; // orange
        } else {
            risk = 0.85 + Math.random() * 0.15; // red
        }

        points.push([
            center.lat + latOffset,
            center.lng + lngOffset,
            risk
        ]);
    }

    return points;
}

function drawRiskHeatmap(center) {
    if (heatLayer) map.removeLayer(heatLayer);

    heatLayer = L.heatLayer(generateRiskPoints(center), {
        radius: 45,
        blur: 18,
        maxZoom: 17,
        minOpacity: 0.6,
        gradient: {
            0.4: "#f1c40f", // yellow
            0.6: "#f39c12", // orange
            0.8: "#e67e22", // dark orange
            1.0: "#e74c3c"  // red
        }
    }).addTo(map);
}

// Get user location
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            userMarker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup("You are here")
                .openPopup();

            map.setView([lat, lng], 15);
            drawRiskHeatmap({ lat, lng });
        },
        () => alert("Location access denied.")
    );
}

// Destination lookup
async function setDestination() {
    const place = document.getElementById("destination").value;
    if (!place || !userMarker) return;

    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(place)}`
        );

        if (!response.ok) throw new Error("Fetch failed");

        const data = await response.json();
        if (!data.length) throw new Error("Not found");

        const lat = data[0].lat;
        const lng = data[0].lon;

        if (destinationMarker) map.removeLayer(destinationMarker);
        destinationMarker = L.marker([lat, lng])
            .addTo(map)
            .bindPopup("Destination")
            .openPopup();

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(
            [userMarker.getLatLng(), [lat, lng]],
            { dashArray: "5,5" }
        ).addTo(map);

        map.fitBounds(routeLine.getBounds());

    } catch (err) {
        alert("Destination lookup failed. Run via localhost.");
        console.error(err);
    }
}

// Legend (risk-only)
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
    const div = L.DomUtil.create("div", "legend");
    div.innerHTML = `
        <strong>Risk Level</strong><br>
        <span style="color:#f1c40f">●</span> Elevated risk<br>
        <span style="color:#f39c12">●</span> High risk<br>
        <span style="color:#e74c3c">●</span> Very high risk
    `;
    return div;
};
legend.addTo(map);
</script>

</body>
</html>
